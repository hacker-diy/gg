<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=960, user-scalable=no">
    <title>Настройки</title>

    <meta name="application-name" content="Настройки">
    <meta name="apple-mobile-web-app-title" content="Настройки">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <meta name="theme-color" content="#000000">
    <meta name="msapplication-navbutton-color" content="#000000">

    <meta name="description" content="Похожее на настройки чудище.">
    <meta name="author" content="Hacker DIY, 2024">
    <meta name="mobile-web-app-capable" content="yes">

    <link rel="icon" href="icon-512.png" type="image/png">
    <link rel="apple-touch-icon" href="icon-512.png">
    <link rel="manifest" href="manifest.json">

    <style type="text/css">
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        html {
            font-size: 32px;
        }

        body {
            background-color: black;
            color: #ffffff;
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            overflow-x: scroll;
            overflow-y: hidden;
            white-space: nowrap;
        }

        #wrapper {
            display: inline-block;
            white-space: nowrap;
        }

        .screen {
            position: relative;
            display: inline-block;
            vertical-align: top;
            width: 960px;
            height: 640px;
            overflow-y: auto;
            overflow-x: hidden;
            white-space: normal;
            padding-top: 80px;
            padding-left: 24px;
            padding-right: 24px;
        }

        #settings {
            scroll-behavior: smooth;
        }

        .back_button {
            display: inline-flex;
            align-items: center;
            position: relative;
            left: -24px;
            padding-left: 24px;
            padding-right: 16px;
            height: 60px;
        }

        .back_button img {
            height: 26px;
            margin-right: 4px;
        }

        .back_button_text {
            font-size: 32px;
            color: #0a84ff;
        }

        .settings_item_screen_header {
            display: flex;
            align-items: center;
            margin-bottom: 24px;
        }

        .settings_item_screen_header_title {
            flex-grow: 1;
            text-align: center;
            font-weight: 600;
            font-size: 32px;
            margin-right: 60px;
        }

        .settings_item_screen_header_extra {
            color: #0a84ff;
            font-size: 28px;
        }

        #search_panel {
            position: fixed;
            top: 0;
            left: 0;
            width: 960px;
            height: 80px;
            background-color: #000000;
            display: flex;
            align-items: center;
            padding-left: 24px;
            padding-right: 24px;
            z-index: 10;
        }

        #search_panel input {
            width: 100%;
            background-color: #1c1c1e;
            border-radius: 12px;
            border: none;
            padding: 10px;
            padding-left: 40px;
            color: #ffffff;
            font-size: 26px;
            outline: none;
        }

        #search_panel img {
            position: absolute;
            left: 40px;
            height: 24px;
            opacity: 0.6;
        }

        .settings_group {
            background-color: #1c1c1e;
            border-radius: 16px;
            margin-bottom: 32px;
            overflow: hidden;
        }

        .settings_group_title {
            color: #a1a1a6;
            font-size: 24px;
            margin: 0 0 8px 12px;
        }

        .settings_item {
            display: flex;
            align-items: center;
            padding: 12px 16px;
            cursor: pointer;
        }

        .settings_item:hover {
            background-color: #2c2c2e;
        }

        .item_icon {
            width: 40px;
            height: 40px;
            margin-right: 12px;
            border-radius: 10px;
            overflow: hidden;
        }

        .item_icon img {
            width: 100%;
            height: 100%;
        }

        .item_title {
            flex-grow: 1;
            font-size: 28px;
        }

        .item_without_icon_title {
            flex-grow: 1;
            font-size: 28px;
            margin-left: 8px;
        }

        .item_status_text {
            margin-right: 8px;
            color: #8e8e93;
            font-size: 26px;
        }

        .item_arrow {
            width: 20px;
            height: 20px;
        }

        .item_arrow img {
            width: 100%;
            height: 100%;
        }

        .separator {
            display: flex;
            align-items: center;
            height: 2px;
            background-color: #000000;
        }

        .separator_offset {
            width: 64px;
            height: 2px;
            background-color: #000000;
        }

        .separator_line {
            flex-grow: 1;
            height: 2px;
            background-color: #2c2c2e;
        }

        .toggle_switch {
            width: 75px;
            height: 43px;
            border-radius: 22px;
            background-color: #3a3a3c;
            position: relative;
            margin-right: 4px;
        }

        .toggle_switch_knob {
            position: absolute;
            top: 3px;
            left: 3px;
            width: 37px;
            height: 37px;
            border-radius: 50%;
            background-color: #ffffff;
            transition: all 0.2s;
        }

        .toggle_switch_on {
            background-color: #34c759;
        }

        .toggle_switch_on .toggle_switch_knob {
            left: 35px;
        }

        #overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 960px;
            height: 640px;
            background-color: #ffffff;
            opacity: 0;
            pointer-events: none;
            z-index: 1000;
        }

        #wifi_networks {
            margin-top: 12px;
        }

        .wifi_networks_title {
            color: #a1a1a6;
            font-size: 22px;
            margin-left: 16px;
            margin-bottom: 4px;
        }

        .settings_description {
            padding: 16px;
            font-size: 22px;
            color: #a1a1a6;
            line-height: 1.3;
        }

        /* --- Magic ESP control screen --- */
        #magic {
            padding-bottom: 40px;
        }
        .magic_wrap {
            min-height: 100%;
            display: flex;
            flex-direction: column;
            gap: 20px;
            padding: 20px 40px 40px 40px;
            box-sizing: border-box;
        }
        .magic_wrap h1 {
            font-size: 32px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin: 20px 0 10px 0;
        }
        .magic_status {
            font-size: 26px;
            margin-bottom: 16px;
        }
        .magic_status_circle {
            width: 26px;
            height: 26px;
            border-radius: 50%;
            background: gray;
            box-shadow: 0 0 6px rgba(0,0,0,0.4);
        }
        .magic_row {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
        }
        .magic_wrap input[type=text] {
            flex: 1;
            padding: 12px 14px;
            font-size: 26px;
            border-radius: 12px;
            border: 2px solid #0bb56b88;
            background: #1c1c1e;
            color: #f5f5f7;
        }
        .magic_wrap button {
            border-radius: 12px;
            border: none;
            padding: 12px 16px;
            font-size: 26px;
            background: #0bb56b;
            color: white;
            cursor: pointer;
        }
        .magic_wrap button.magic_stop {
            background: #d33;
        }
        .magic_quickpad {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 16px;
        }
        .magic_quickpad button {
            flex: 1 0 18%;
            padding: 10px 0;
            font-size: 24px;
        }
    </style>

    <script src="jquery-3.7.1.min.js"></script>
    <script src="jquery.cookie.js"></script>

</head>
<body>

<div id="search_panel">
    <img src="search_icon.png">
    <input id="search_input" type="text" placeholder="Поиск">
</div>

<div id="overlay"></div>

<div id="wrapper">
    <div id="settings" class="screen"></div>
    <div id="wifi" class="screen"></div>
    <div id="config" class="screen"></div>
    <div id="magic" class="screen">
        <div class="settings_item_screen_header">
            <div class="back_button">
                <img src="back_arrow.png">
                <div class="back_button_text">Конфиденциальность</div>
            </div>
            <div class="settings_item_screen_header_title">Имя сети для подмены</div>
        </div>

        <div class="magic_wrap">
            <h1>
                <span>ESP Magic Control</span>
                <div id="magic_led" class="magic_status_circle"></div>
            </h1>

            <div class="magic_status">Статус: <b id="magic_st">…</b></div>

            <form id="magic_setForm">
                <div class="magic_row">
                    <input type="text" id="magic_ssidInput" name="text" placeholder="Введите магическую фразу…" maxlength="64" required>
                    <button type="submit">✨ Установить</button>
                </div>
            </form>

            <div class="magic_row" style="margin-top: 10px;">
                <button id="magic_startBtn">▶️ Начать показ</button>
                <button class="magic_stop" id="magic_stopBtn">⏹ Остановить</button>
            </div>

            <div class="magic_quickpad" id="magic_quickpad_numbers">
                <button type="button">1</button>
                <button type="button">2</button>
                <button type="button">3</button>
                <button type="button">4</button>
                <button type="button">5</button>
                <button type="button">6</button>
                <button type="button">7</button>
                <button type="button">8</button>
                <button type="button">9</button>
                <button type="button">0</button>
                <button type="button">.</button>
                <button type="button" data-action="backspace">←</button>
            </div>

            <div class="magic_quickpad" id="magic_quickpad_suits">
                <button type="button" data-value="♠️">♠️</button>
                <button type="button" data-value="♣️">♣️</button>
                <button type="button" data-value="♥️">♥️</button>
                <button type="button" data-value="♦️">♦️</button>
            </div>

            <div class="magic_quickpad" id="magic_quickpad_cards">
                <button type="button">A</button>
                <button type="button">K</button>
                <button type="button">Q</button>
                <button type="button">J</button>
            </div>
        </div>
    </div>
</div>

<script type="text/javascript">
settings_groups = [
    {
        title: null,
        options: [
            {
                icon: 'settings_apple_id.png',
                title: 'Hacker DIY',
                status: 'Apple ID, iCloud, медиа и покупки',
                screen: null
            }
        ]
    },
    {
        title: null,
        options: [
            {
                icon: 'settings_airplane.png',
                title: 'Авиарежим',
                status: null,
                screen: null
            },
            {
                icon: 'settings_wifi.png',
                title: 'Wi-Fi',
                status: 'Не подключено',
                screen: 'wifi'
            },
            {
                icon: 'settings_bluetooth.png',
                title: 'Bluetooth',
                status: 'Выключено',
                screen: null
            },
            {
                icon: 'settings_cellular.png',
                title: 'Сотовая связь',
                status: null,
                screen: null
            },
            {
                icon: 'settings_hotspot.png',
                title: 'Режим модема',
                status: null,
                screen: null
            }
        ]
    },
    {
        title: null,
        options: [
            {
                icon: 'settings_notifications.png',
                title: 'Уведомления',
                status: null,
                screen: null
            },
            {
                icon: 'settings_sounds.png',
                title: 'Звуки, тактильные сигналы',
                status: null,
                screen: null
            },
            {
                icon: 'settings_focus.png',
                title: 'Режим фокусирования',
                status: 'Выкл.',
                screen: null
            },
            {
                icon: 'settings_screen_time.png',
                title: 'Экранное время',
                status: null,
                screen: null
            }
        ]
    },
    {
        title: null,
        options: [
            {
                icon: 'settings_general.png',
                title: 'Основные',
                status: null,
                screen: null
            },
            {
                icon: 'settings_control_center.png',
                title: 'Пункт управления',
                status: null,
                screen: null
            },
            {
                icon: 'settings_display.png',
                title: 'Экран и яркость',
                status: null,
                screen: null
            },
            {
                icon: 'settings_home_screen.png',
                title: 'Экран «Домой» и Библиотека приложений',
                status: null,
                screen: null
            },
            {
                icon: 'settings_accessibility.png',
                title: 'Универсальный доступ',
                status: null,
                screen: null
            },
            {
                icon: 'settings_wallpaper.png',
                title: 'Обои',
                status: null,
                screen: null
            },
            {
                icon: 'settings_siri.png',
                title: 'Siri и Поиск',
                status: null,
                screen: null
            },
            {
                icon: 'settings_touch_id.png',
                title: 'Face ID и код-пароль',
                status: null,
                screen: null
            }
        ]
    },
    {
        title: null,
        options: [
            {
                icon: 'settings_sos.png',
                title: 'Экстренный вызов — SOS',
                status: null,
                screen: null
            },
            {
                icon: 'settings_exposure.png',
                title: 'Уведомления о контакте',
                status: null,
                screen: null
            },
            {
                icon: 'settings_battery.png',
                title: 'Аккумулятор',
                status: null,
                screen: null
            },
            {
                icon: 'settings_privacy.png',
                title: 'Конфиденциальность и безопасность',
                status: null,
                screen: 'config'
            }
        ]
    },
    {
        title: null,
        options: [
            {
                icon: 'settings_app_store.png',
                title: 'App Store',
                status: null,
                screen: null
            },
            {
                icon: 'settings_wallet.png',
                title: 'Wallet и Apple Pay',
                status: null,
                screen: null
            }
        ]
    },
    {
        title: null,
        options: [
            {
                icon: 'settings_passwords.png',
                title: 'Пароли',
                status: null,
                screen: null
            },
            {
                icon: 'settings_mail.png',
                title: 'Почта',
                status: null,
                screen: null
            },
            {
                icon: 'settings_contacts.png',
                title: 'Контакты',
                status: null,
                screen: null
            },
            {
                icon: 'settings_calendar.png',
                title: 'Календарь',
                status: null,
                screen: null
            },
            {
                icon: 'settings_notes.png',
                title: 'Заметки',
                status: null,
                screen: null
            },
            {
                icon: 'settings_reminders.png',
                title: 'Напоминания',
                status: null,
                screen: null
            },
            {
                icon: 'settings_voice_memos.png',
                title: 'Диктофон',
                status: null,
                screen: null
            },
            {
                icon: 'settings_phone.png',
                title: 'Телефон',
                status: null,
                screen: null
            }
        ]
    },
    {
        title: null,
        options: [
            {
                icon: 'settings_messages.png',
                title: 'Сообщения',
                status: null,
                screen: null
            },
            {
                icon: 'settings_facetime.png',
                title: 'FaceTime',
                status: null,
                screen: null
            },
            {
                icon: 'settings_safari.png',
                title: 'Safari',
                status: null,
                screen: null
            },
            {
                icon: 'settings_stocks.png',
                title: 'Акции',
                status: null,
                screen: null
            },
            {
                icon: 'settings_translate.png',
                title: 'Перевод',
                status: null,
                screen: null
            },
            {
                icon: 'settings_maps.png',
                title: 'Карты',
                status: null,
                screen: null
            }
        ]
    },
    {
        title: null,
        options: [
            {
                icon: 'settings_compass.png',
                title: 'Компас',
                status: null,
                screen: null
            },
            {
                icon: 'settings_measure.png',
                title: 'Рулетка',
                status: null,
                screen: null
            },
            {
                icon: 'settings_shortcuts.png',
                title: 'Быстрые команды',
                status: null,
                screen: null
            }
        ]
    }
]

config_groups = [
    {
        title: null,
        options: [
            {
                icon: 'settings_privacy.png',
                title: 'Услуги геолокации',
                status: 'Выкл.',
                type: 'switch',
                id: 'location_services'
            }
        ]
    },
    {
        title: 'КОНФИДЕНЦИАЛЬНОСТЬ И БЕЗОПАСНОСТЬ',
        options: [
            {
                icon: null,
                title: 'Контакты',
                status: null,
                type: 'item'
            },
            {
                icon: null,
                title: 'Календарь',
                status: null,
                type: 'item'
            },
            {
                icon: null,
                title: 'Напоминания',
                status: null,
                type: 'item'
            },
            {
                icon: null,
                title: 'Фото',
                status: null,
                type: 'item'
            }
        ]
    },
    {
        title: null,
        options: [
            {
                icon: null,
                title: 'Режим защиты',
                status: 'Выкл.',
                type: 'item'
            }
        ]
    },
    {
        title: null,
        options: [
            {
                icon: null,
                title: 'Аналитика и улучшения',
                status: null,
                type: 'item'
            },
            {
                icon: null,
                title: 'Реклама',
                status: null,
                type: 'item'
            }
        ]
    },
    {
        title: 'ДЛЯ HACKER DIY',
        options: [
            {
                icon: null,
                title: 'Hacker',
                status: null,
                type: 'item'
            }
        ]
    }
]

parent_screens = ['wifi', 'config']

password = $.cookie('password')
if (password == null) {
    password = prompt('Введите пароль:')
    $.cookie('password', password)
}

working_mode = $.cookie('working_mode')
if (working_mode == null) {
    working_mode = '1'
}

magic_delay = $.cookie('magic_delay')
if (magic_delay == null) {
    magic_delay = 2
}

magic_delay = Number(magic_delay)

forced_name = $.cookie('forced_name')
if (forced_name == null) {
    forced_name = 'BEST MAGICS'
}

wifi_networks = $.cookie('wifi_networks')
if (wifi_networks == null) {
    wifi_networks = [
        'Home-WiFi',
        'Airport',
        'Guest',
        'Hacker DIY Lab',
        'MacBook Ars',
        'iPad Pro',
        'Printer',
        'AirPort Express',
        'Office',
        'Cafe_5G'
    ]
} else {
    wifi_networks = wifi_networks.split(',')
}

function build_settings_screen() {
    $('#settings').empty()

    settings_groups.forEach(function (group) {
        var group_div = $('<div></div>')

        if (group.title != null) {
            var title_div = $('<div class="settings_group_title"></div>')
            title_div.text(group.title)
            group_div.append(title_div)
        }

        var options_div = $('<div class="settings_group"></div>')
        group.options.forEach(function (option, index) {
            var item_div = $('<div class="settings_item"></div>')

            if (option.icon != null) {
                var icon_div = $('<div class="item_icon"></div>')
                icon_div.append($('<img src="' + option.icon + '">'))
                item_div.append(icon_div)
            }

            var title_div = $('<div class="item_title"></div>')
            title_div.text(option.title)
            item_div.append(title_div)

            if (option.status != null) {
                var status_div = $('<div class="item_status_text"></div>')
                status_div.text(option.status)
                item_div.append(status_div)
            }

            var arrow_div = $('<div class="item_arrow"></div>')
            arrow_div.append($('<img src="arrow.png">'))
            item_div.append(arrow_div)

            if (option.screen != null) {
                item_div.click(function () {
                    show_screen(option.screen)
                })
            }

            options_div.append(item_div)

            if (index != group.options.length - 1) {
                var separator = $('<div class="separator"><div class="separator_offset"></div><div class="separator_line"></div></div>')
                options_div.append(separator)
            }
        })

        group_div.append(options_div)
        $('#settings').append(group_div)
    })
}

function show_screen(screen_id) {
    // Отдельный режим для экрана ESP Magic Control
    if (screen_id === 'magic') {
        // Прячем стандартные экраны
        $('#settings').hide()
        $('#wifi').hide()
        $('#config').hide()

        // Показываем магический экран
        $('#magic').show()

        // Инициализируем логику один раз
        if (typeof init_magic === 'function') {
            init_magic()
        }

        $(window).scrollTop(0)
        return
    }

    // Дальше — старое поведение для wifi/config
    build_wifi_screen()
    build_config_screen()

    // Прячем только стандартные экраны
    parent_screens.forEach(function (sid) {
        $('#' + sid).hide()
    })

    $('#wifi_networks').hide()
    $('#' + screen_id).show()
    $('body').animate(
        { scrollLeft: $('#' + screen_id).offset().left },
        {
            duration: 400,
            complete: function () {
                // Сеточки выезжают только на экране Wi-Fi
                if (screen_id === 'wifi') {
                    $('#wifi_networks').slideDown(400)
                }
            }
        }
    )
    $(window).scrollTop(0)
}

function build_wifi_screen() {
    $('#wifi').empty()

    var back_button = $('<div class="back_button"></div>')
    back_button.append($('<img src="back_arrow.png">'))
    back_button.append($('<div class="back_button_text">Настройки</div>'))
    back_button.click(function () { show_screen('settings') })

    var wifi_header_div = $('<div class="settings_item_screen_header"></div>')
    wifi_header_div.append(back_button)
    wifi_header_div.append($('<div class="settings_item_screen_header_title">Wi-Fi</div>'))
    wifi_header_div.append($('<div class="settings_item_screen_header_extra">Изменить</div>'))
    $('#wifi').append(wifi_header_div)

    var options_div = $('<div class="settings_group"></div>')

    var wifi_switch_item = $('<div class="settings_item"></div>')
    wifi_switch_item.append($('<div class="item_without_icon_title">Wi-Fi</div>'))

    var switch_div = $('<div class="toggle_switch toggle_switch_on"></div>')
    switch_div.append($('<div class="toggle_switch_knob"></div>'))
    wifi_switch_item.append(switch_div)

    wifi_switch_item.click(function () {
        show_magic()
    })
    options_div.append(wifi_switch_item)

    options_div.append($('<div class="separator"><div class="separator_offset"></div><div class="separator_line"></div></div>'))

    var item_div = $('<div class="settings_item"></div>')
    item_div.append($('<div class="item_without_icon_title">Hacker_WIFI</div>'))
    item_div.append($('<div class="item_status_text">защищено паролем</div>'))
    item_div.append($('<div class="item_arrow"><img src="arrow.png"></div>'))

    item_div.click(function () {
        show_magic()
    })

    options_div.append(item_div)

    var wifi_networks_div = $('<div id="wifi_networks"></div>')

    $('#wifi').append(options_div)

    var group_title_div = $('<div class="wifi_networks_title">СЕТИ</div>')
    $('#wifi').append(group_title_div)
    $('#wifi').append(wifi_networks_div)
}

function show_magic() {
    console.log('Magic time!')
    var delay = 1000 * magic_delay
    setTimeout(function () { blink_screen(10) }, delay)
    var wifi_networks_dom = $('#wifi_networks > .settings_item')
    for (var i = 0; i < 10; i++) {
        delay += 800
        if (wifi_networks_dom[i] != null) {
            rename_network(i, delay)
        }
        setTimeout(function () { add_network() }, delay)
    }
}

function add_network() {
    var wifi_networks_div = $('#wifi_networks')
    var item_div = $('<div class="settings_item"></div>')
    item_div.append($('<div class="item_without_icon_title">' + forced_name + '</div>'))
    item_div.append($('<div class="item_status_text">защищено паролем</div>'))
    wifi_networks_div.append(item_div)
}

function rename_network(index, delay) {
    setTimeout(function () {
        var wifi_networks_dom = $('#wifi_networks > .settings_item')
        var name_div = $($(wifi_networks_dom[index]).children()[0])
        name_div.animate({opacity: 0}, {
            duration: 1000, complete: function () {
                name_div.text(forced_name)
                name_div.animate({opacity: 100}, 500)
            }
        })
    }, delay)
}

function blink_screen(count) {
    $('#overlay').show()
    setTimeout(function () {
        $('#overlay').hide()
        count--
        if (count > 0) {
            setTimeout(function () { blink_screen(count) }, 50)
        }
    }, 50)
}

function build_config_screen() {
    $('#config').empty()

    var back_button = $('<div class="back_button"></div>')
    back_button.append($('<img src="back_arrow.png">'))
    back_button.append($('<div class="back_button_text">Настройки</div>'))
    back_button.click(function () { show_screen('settings') })

    var config_header_div = $('<div class="settings_item_screen_header"></div>')
    config_header_div.append(back_button)
    config_header_div.append($('<div class="settings_item_screen_header_title">Hacker</div>'))
    $('#config').append(config_header_div)

    var group_div = $('<div class="settings_group"></div>')
    var options_div = $('<div></div>')

    var item_div = $('<div class="settings_item"></div>')
    item_div.append($('<div class="item_without_icon_title">Пароль</div>'))
    item_div.append($('<div class="item_status_text">' + password + '</div>'))
    item_div.click(function () { change_password() })
    options_div.append(item_div)

    options_div.append($('<div class="separator"><div class="separator_offset"></div><div class="separator_line"></div></div>'))

    var item_div = $('<div class="settings_item"></div>')
    item_div.append($('<div class="item_without_icon_title">Имя сети для подмены</div>'))
    item_div.append($('<div class="item_status_text">' + forced_name + '</div>'))
    item_div.click(function () { show_screen('magic') })
    options_div.append(item_div)

    options_div.append($('<div class="separator"><div class="separator_offset"></div><div class="separator_line"></div></div>'))

    var item_div = $('<div class="settings_item"></div>')
    item_div.append($('<div class="item_without_icon_title">Режим работы</div>'))
    item_div.append($('<div class="item_status_text">' + working_mode + '</div>'))
    item_div.click(function () { change_working_mode() })
    options_div.append(item_div)

    options_div.append($('<div class="separator"><div class="separator_offset"></div><div class="separator_line"></div></div>'))

    var item_div = $('<div class="settings_item"></div>')
    item_div.append($('<div class="item_without_icon_title">Задержка в секундах</div>'))
    item_div.append($('<div class="item_status_text">' + magic_delay + '</div>'))
    item_div.click(function () { change_magic_delay() })
    options_div.append(item_div)

    options_div.append($('<div class="separator"><div class="separator_offset"></div><div class="separator_line"></div></div>'))

    for (var i = 0; i < wifi_networks.length; i++) {
        var item_div = $('<div class="settings_item"></div>')
        item_div.append($('<div class="item_without_icon_title">Сеть ' + i + '</div>'))
        item_div.append($('<div class="item_status_text">' + wifi_networks[i] + '</div>'))
        item_div.click((function (index) {
            return function () { change_network_name(index) }
        })(i))
        options_div.append(item_div)

        if (i != wifi_networks.length - 1) {
            options_div.append($('<div class="separator"><div class="separator_offset"></div><div class="separator_line"></div></div>'))
        }
    }

    group_div.append(options_div)
    $('#config').append(group_div)
}

function change_password() {
    var input = prompt('Введите новый пароль:', password)
    if (input == null) {
        return
    }
    password = input
    $.cookie('password', password)
    build_config_screen()
}

function change_working_mode() {
    var input = prompt('Режим работы (1 или 2):')
    if (input == null) {
        return
    }
    if (input == '1' || input == '2') {
        working_mode = input
        $.cookie('working_mode', working_mode)
        build_config_screen()
    } else {
        alert('Вы ввели неверное значение. Допустимые: 1 или 2.')
    }
    build_config_screen()
}

function change_magic_delay() {
    var input = prompt('Задержка в секундах:')
    if (input == null) {
        return
    }
    var delay = Number(input)
    if (!isNaN(delay)) {
        magic_delay = delay
        $.cookie('magic_delay', magic_delay)
        build_config_screen()
    } else {
        alert('Вы ввели не число')
    }
}

function change_network_name(index) {
    var input = prompt('Сеть ' + index + ':')
    if (input == null) {
        return
    }
    wifi_networks[index] = input
    $.cookie('wifi_networks', wifi_networks)
    build_config_screen()
}

var magic_initialized = false;

function init_magic() {
    if (magic_initialized) return;
    magic_initialized = true;

    var st = document.getElementById('magic_st');
    if (!st) return;

    var led = document.getElementById('magic_led');
    var form = document.getElementById('magic_setForm');
    var ssidInput = document.getElementById('magic_ssidInput');
    var startBtn = document.getElementById('magic_startBtn');
    var stopBtn = document.getElementById('magic_stopBtn');

    var ESP_BASE = 'http://192.168.4.1';

    async function refresh() {
        try {
            var res = await fetch(ESP_BASE + '/status');
            var t = await res.text();
            st.innerText = t;

            var ssidMatch = t.match(/Текущая фраза: (.+)$/m) || t.match(/SSID: (.+)$/m);
            if (ssidMatch) {
                ssidInput.placeholder = ssidMatch[1];
                forced_name = ssidMatch[1];
                $.cookie('forced_name', forced_name);
                build_config_screen();
            }
            if (t.indexOf('включены') !== -1) {
                led.style.background = 'limegreen';
            } else if (t.indexOf('ожидании') !== -1) {
                led.style.background = 'orange';
            } else {
                led.style.background = 'red';
            }
        } catch (e) {
            st.innerText = 'нет связи';
            led.style.background = 'gray';
        }
    }

    setInterval(refresh, 1500);
    refresh();

    form.addEventListener('submit', async function (e) {
        e.preventDefault();
        var text = ssidInput.value.trim();
        if (!text) return;
        forced_name = text;
        $.cookie('forced_name', forced_name);
        build_config_screen();
        await fetch(ESP_BASE + '/set?text=' + encodeURIComponent(text));
        ssidInput.value = '';
        refresh();
    });

    startBtn.addEventListener('click', async function () {
        await fetch(ESP_BASE + '/start');
        refresh();
    });

    stopBtn.addEventListener('click', async function () {
        await fetch(ESP_BASE + '/stop');
        refresh();
    });

    ['magic_quickpad_numbers', 'magic_quickpad_suits', 'magic_quickpad_cards'].forEach(function (id) {
        var pad = document.getElementById(id);
        if (!pad) return;
        pad.addEventListener('click', function (e) {
            var btn = e.target.closest('button');
            if (!btn) return;
            var action = btn.getAttribute('data-action');
            if (action === 'backspace') {
                ssidInput.value = ssidInput.value.slice(0, -1);
                return;
            }
            var val = btn.getAttribute('data-value') || btn.textContent;
            if (val) {
                ssidInput.value += val;
            }
        });
    });
}

$(document).ready(function () {
    build_settings_screen()
    show_screen('settings')
})
</script>

</body>
<html>
